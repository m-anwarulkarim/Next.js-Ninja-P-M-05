## ЁЯза ржорзВрж▓ ржЖрж░рзНржХрж┐ржЯрзЗржХржЪрж╛рж░ (Core Concept)

- тЬЕ **рж╕рзЗржирзНржЯрзНрж░рж╛рж▓ ржХржирзНржЯрзНрж░рзЛрж▓:** ржкрзНрж░ржЬрзЗржХрзНржЯрзЗ `proxy.ts` ржлрж╛ржЗрж▓ **рззржЯрж╛ржЗ** ржерж╛ржХржмрзЗред
- тЭМ **ржирзЛ ржорзЗрж╕:** рж╕ржм рж▓ржЬрж┐ржХ ржПржХ ржлрж╛ржЗрж▓рзЗ рж▓рж┐ржЦрзЗ ржЬржЯ ржкрж╛ржХрж╛ржирзЛ ржпрж╛ржмрзЗ ржирж╛ред
- ЁЯСЙ **ржХржирж╕рзЗржкрзНржЯ:** `proxy.ts` рж╣ржмрзЗ ржЖржорж╛ржжрзЗрж░ **Main Hub/Controller**, ржЖрж░ рж╕ржм рж▓ржЬрж┐ржХ ржерж╛ржХржмрзЗ ржЖрж▓рж╛ржжрж╛ ржЖрж▓рж╛ржжрж╛ ржоржбрж┐ржЙрж▓рзЗред

---

## ЁЯУБ Recommended Folder Structure

ржПржХржЯрж┐ ржХрзНрж▓рж┐ржи ржкрзНрж░ржЬрзЗржХрзНржЯрзЗрж░ ржЬржирзНржп ржПржЗ ржлрзЛрж▓рзНржбрж╛рж░ рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ржЯрж┐ ржлрж▓рзЛ ржХрж░рж╛ ржмрзЗрж╕рзНржЯ ржкрзНрж░рзНржпрж╛ржХржЯрж┐рж╕:

```text
src/
 тФЬтФА app/
 тФЬтФА pages/
 тФЬтФА proxy.ts                ЁЯСИ Entry Point (рж╢рзБржзрзБ ржЯрзНрж░рж╛ржлрж┐ржХ ржХржирзНржЯрзНрж░рзЛрж▓ ржХрж░ржмрзЗ)
 тФФтФА proxy/                  ЁЯСИ рж▓ржЬрж┐ржХ рж╣рж╛ржм (рж╕ржм ржЖрж▓рж╛ржжрж╛ ржЖрж▓рж╛ржжрж╛ ржлрж╛ржЗрж▓)
     тФЬтФА auth.proxy.ts       (Authentication рж▓ржЬрж┐ржХ)
     тФЬтФА abtest.proxy.ts     (A/B Testing рж▓ржЬрж┐ржХ)
     тФЬтФА locale.proxy.ts     (Language/Country рж▓ржЬрж┐ржХ)
     тФФтФА index.ts            (ржРржЪрзНржЫрж┐ржХ: рж╕ржм ржоржбрж┐ржЙрж▓ ржПржХрзНрж╕ржкрзЛрж░рзНржЯ ржХрж░рж╛рж░ ржЬржирзНржп)

```

---

## ЁЯзй Step 1: ржоржбрж┐ржЙрж▓рж╛рж░ ржкрзНрж░ржХрзНрж╕рж┐ рж▓ржЬрж┐ржХ рждрзИрж░рж┐ ржХрж░рж╛

ржирж┐ржЪрзЗрж░ ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ `src/proxy/` ржлрзЛрж▓рзНржбрж╛рж░рзЗрж░ ржнрзЗрждрж░рзЗ ржерж╛ржХржмрзЗред

### ЁЯУД рзз. Auth Proxy (`auth.proxy.ts`)

```ts
import { NextRequest, NextResponse } from "next/server";

export function authProxy(request: NextRequest) {
  const token = request.cookies.get("token");

  // ржпржжрж┐ ржЯрзЛржХрзЗржи ржирж╛ ржерж╛ржХрзЗ, рж╕рж░рж╛рж╕рж░рж┐ рж▓ржЧржЗржи ржкрзЗржЬрзЗ ржкрж╛ржарж┐рзЯрзЗ ржжрж╛ржУ
  if (!token) {
    return NextResponse.redirect(new URL("/login", request.url));
  }
}
```

### ЁЯУД рзи. Locale Proxy (`locale.proxy.ts`)

```ts
import { NextRequest, NextResponse } from "next/server";

export function localeProxy(request: NextRequest) {
  const country = request.headers.get("x-country");

  // ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ рж╣рж▓рзЗ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж░рж╛ржЙржЯрзЗ рж░рж┐рж░рж╛ржЗржЯ ржХрж░рзЛ
  if (country === "BD") {
    return NextResponse.rewrite(
      new URL("/bn" + request.nextUrl.pathname, request.url),
    );
  }
}
```

### ЁЯУД рзй. A/B Test Proxy (`abtest.proxy.ts`)

```ts
import { NextRequest, NextResponse } from "next/server";

export function abTestProxy(request: NextRequest) {
  const bucket = Math.random() > 0.5 ? "version-a" : "version-b";

  if (bucket === "version-b") {
    return NextResponse.rewrite(
      new URL("/v2" + request.nextUrl.pathname, request.url),
    );
  }
}
```

---

## ЁЯза Step 2: Main `proxy.ts` (The Controller)

ржПржЗ ржлрж╛ржЗрж▓ржЯрж┐ ржЖржкржирж╛рж░ ржкрзНрж░ржЬрзЗржХрзНржЯрзЗрж░ рж░рзБржЯ ржмрж╛ `src/` ржП ржерж╛ржХржмрзЗред ржПржЯрж┐ рж╕ржмржЧрзБрж▓рзЛ ржоржбрж┐ржЙрж▓ржХрзЗ ржЪрзЗржЗржи ржЖржХрж╛рж░рзЗ ржХрж▓ ржХрж░ржмрзЗред

### ЁЯУД `src/proxy.ts`

```ts
import { NextRequest, NextResponse } from "next/server";
import { authProxy } from "./proxy/auth.proxy";
import { localeProxy } from "./proxy/locale.proxy";
import { abTestProxy } from "./proxy/abtest.proxy";

export function proxy(request: NextRequest) {
  // ржЪрзЗржЗржи ржЪрзНржпрж╛ржХрж┐ржВ: ржкрзНрж░ржержо ржпрзЗржЯрж╛ ржорзНржпрж╛ржЪ ржХрж░ржмрзЗ рж╕рзЗржЯрж╛ржЗ рж░рж┐ржЯрж╛рж░рзНржи рж╣ржмрзЗ
  return (
    authProxy(request) ??
    localeProxy(request) ??
    abTestProxy(request) ??
    NextResponse.next() // ржХрзЛржирзЛржЯрж┐ ржирж╛ ржорж┐рж▓рж▓рзЗ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ рж╕рж╛ржоржирзЗ ржПржЧрж┐рзЯрзЗ ржпрж╛ржмрзЗ
  );
}

// ржХрзЛржи ржХрзЛржи ржкрж╛ржерзЗ ржкрзНрж░ржХрзНрж╕рж┐ ржХрж╛ржЬ ржХрж░ржмрзЗ рждрж╛рж░ ржХржиржлрж┐ржЧ
export const config = {
  matcher: [
    "/dashboard/:path*",
    "/about/:path*",
    "/((?!api|_next|static|favicon.ico).*)",
  ],
};
```

---

## ЁЯФН ржХрзЗржи ржПржЗ ржкрзНржпрж╛ржЯрж╛рж░рзНржиржЯрж┐ рж╕рзЗрж░рж╛?

| рж╕рзБржмрж┐ржзрж╛           | ржмрзНржпрж╛ржЦрзНржпрж╛                                                                                   |
| ---------------- | ------------------------------------------------------------------------------------------ |
| **Readable**     | `proxy.ts` ржЦрзБрж▓рж▓рзЗржЗ ржПржХ ржиржЬрж░рзЗ рж╕ржм рж▓ржЬрж┐ржХ ржЪрзЗржЗржи ржжрзЗржЦрж╛ ржпрж╛рзЯред                                           |
| **Scalable**     | ржирждрзБржи ржХрзЛржирзЛ ржлрж┐ржЪрж╛рж░ (ржпрзЗржоржи: Maintenance Mode) ржЖрж╕рж▓рзЗ рж╢рзБржзрзБ ржирждрзБржи ржлрж╛ржЗрж▓ ржпрзЛржЧ ржХрж░рж▓рзЗржЗ рж╣рзЯред                 |
| **Isolated**     | ржПржХржЯрж╛ рж▓ржЬрж┐ржХ ржПржбрж┐ржЯ ржХрж░рждрзЗ ржЧрж┐рзЯрзЗ ржЕржирзНржпржЯрж╛рждрзЗ ржмрж╛ржЧ (Bug) ржврзЛржХрж╛рж░ ржнрзЯ ржирзЗржЗред                                  |
| **Pro-Standard** | ржПржЯрж┐ ржорзВрж▓ржд **"Middleware Chain"** ржбрж┐ржЬрж╛ржЗржи ржкрзНржпрж╛ржЯрж╛рж░рзНржи, ржпрж╛ ржмрзЬ ржПржирзНржЯрж╛рж░ржкрзНрж░рж╛ржЗржЬ ржкрзНрж░ржЬрзЗржХрзНржЯрзЗ ржмрзНржпржмрж╣рзГржд рж╣рзЯред |

---

## тЪая╕П ржоржирзЗ рж░рж╛ржЦрж╛рж░ ржорждрзЛ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржирж┐рзЯржо

ржкрзНрж░ржХрзНрж╕рж┐ ржлрж╛ржВрж╢ржиржЧрзБрж▓рзЛ рж▓рзЗржЦрж╛рж░ рж╕ржорзЯ ржПржХржЯрж┐ ржмрж┐рж╖рзЯ ржорж╛ржерж╛рзЯ рж░рж╛ржЦрждрзЗ рж╣ржмрзЗ:

- ржпржжрж┐ ржХржирзНржбрж┐рж╢ржи ржорзНржпрж╛ржЪ ржХрж░рзЗ, рждржмрзЗржЗ `NextResponse` рж░рж┐ржЯрж╛рж░рзНржи ржХрж░ржмрзЗред
- ржпржжрж┐ ржХржирзНржбрж┐рж╢ржи ржорзНржпрж╛ржЪ ржирж╛ ржХрж░рзЗ, рждржмрзЗ ржЕржмрж╢рзНржпржЗ `undefined` (ржмрж╛ ржХрж┐ржЫрзБ ржирж╛) рж░рж┐ржЯрж╛рж░рзНржи ржХрж░ржмрзЗред

> **Mental Model:**
> `proxy.ts` рж╣рж▓рзЛ ржПржХржЬржи **Traffic Police**, ржЖрж░ `proxy/*.ts` ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ рж╣рж▓рзЛ ржПржХрзЗржХржЯрж┐ **Traffic Rule**ред ржкрзБрж▓рж┐рж╢ рж╢рзБржзрзБ рж░рзБрж▓
